<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Ore Dipendenti</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ore Dipendenti">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- Login Page -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="logo">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" fill="currentColor"/>
                        </svg>
                    </div>
                    <h1>Gestione Ore</h1>
                    <p>Accedi al sistema</p>
                </div>
                <form id="loginForm" class="login-form">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn btn-primary">Accedi</button>
                    <div id="loginError" class="error-message"></div>
                </form>
                <div class="login-footer" id="loginFooter">
                    <p>Inserisci il tuo username nel formato: <strong>nome_cognome</strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Page -->
    <div id="appPage" class="page">
        <nav class="navbar">
            <div class="navbar-content">
                <div class="navbar-left">
                    <div class="logo-small">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" fill="currentColor"/>
                        </svg>
                    </div>
                    <h2>Gestione Ore</h2>
                </div>
                <div class="navbar-right">
                    <button id="holidaysBtn" class="btn btn-icon" title="Festivit√†">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 2v3M16 2v3M3.5 9.09h17M21 8.5V17c0 3-1.5 5-5 5H8c-3.5 0-5-2-5-5V8.5c0-3 1.5-5 5-5h8c3.5 0 5 2 5 5z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M15.695 13.7h.009M15.695 16.7h.009M11.995 13.7h.01M11.995 16.7h.01M8.294 13.7h.01M8.294 16.7h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button id="usersManagementBtn" class="btn btn-icon" title="Gestione Utenti" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M8.5 11a4 4 0 100-8 4 4 0 000 8zM20 8v6M23 11h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button id="darkModeToggle" class="btn btn-icon" title="Toggle Dark Mode">
                        <svg id="darkModeIcon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button id="notificationsBtn" class="btn btn-icon" title="Attiva Notifiche" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 8A6 6 0 106 8c0 7-3 9-3 9h18s-3-2-3-9zM13.73 21a2 2 0 01-3.46 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button id="changePasswordBtn" class="btn btn-icon" title="Cambia Password">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM8.9 6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2H8.9V6zM18 20H6V10h12v10z" fill="currentColor"/>
                        </svg>
                    </button>
                    <span id="userDisplay" class="user-display"></span>
                    <button id="logoutBtn" class="btn btn-secondary">Esci</button>
                </div>
            </div>
        </nav>

        <div class="main-content">
            <div class="container">
                <!-- View Toggle (only for admin) -->
                <div id="viewToggle" class="view-toggle" style="display: none;">
                    <button id="calendarViewBtn" class="toggle-btn active">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z" fill="currentColor"/>
                        </svg>
                        Vista Calendario
                    </button>
                    <button id="tableViewBtn" class="toggle-btn">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 3h18v2H3V3zm0 4h18v2H3V7zm0 4h18v2H3v-2zm0 4h18v2H3v-2zm0 4h18v2H3v-2z" fill="currentColor"/>
                        </svg>
                        Vista Tabella
                    </button>
                </div>

                <!-- Calendar Header -->
                <div class="calendar-header">
                    <button id="prevMonth" class="btn btn-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="currentColor"/>
                        </svg>
                    </button>
                    <h2 id="currentMonth"></h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="exportExcelBtn" class="btn btn-success" style="display: none;">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 5px;">
                                <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z" fill="currentColor"/>
                                <path d="M8 15.5l1.5 2L12 14l2.5 3.5L16 15" stroke="currentColor" stroke-width="1.5"/>
                            </svg>
                            Esporta Excel
                        </button>
                        <button id="nextMonth" class="btn btn-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Admin User Selection -->
                <div id="adminUserSelection" class="admin-section" style="display: none;">
                    <label for="userSelect">Visualizza dipendente:</label>
                    <select id="userSelect" class="user-select">
                        <option value="alessandro_costantini">Alessandro Costantini (Tu)</option>
                        <option value="denise_raimondi">Denise Raimondi</option>
                        <option value="sandy_oduro">Sandy Oduro</option>
                        <option value="luca_avesani">Luca Avesani</option>
                        <option value="sophie_rizzin">Sophie Rizzin</option>
                        <option value="sofia_bilianska">Sofia Bilianska</option>
                    </select>
                </div>

                <!-- Ferie/ROL Residui -->
                <div id="leaveBalance" class="leave-balance" style="display: none;">
                    <div class="balance-card">
                        <div class="balance-icon">üèñÔ∏è</div>
                        <div class="balance-content">
                            <div class="balance-label">Ferie Residue</div>
                            <div class="balance-value" id="ferieResidue">26 gg</div>
                        </div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-icon">üìÖ</div>
                        <div class="balance-content">
                            <div class="balance-label">ROL Residui</div>
                            <div class="balance-value" id="rolResidui">120h</div>
                        </div>
                    </div>
                </div>

                <!-- Admin: User Management -->
                <div id="adminUserManagement" class="admin-section modal" style="display: none;">
                    <div class="modal-content" style="max-width: 900px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;">üë• Gestione Utenti</h3>
                            <button id="closeUsersModal" class="btn btn-secondary" style="display: flex; align-items: center; gap: 5px;">
                                <span>&times;</span>
                                <span>Chiudi</span>
                            </button>
                        </div>
                        <div class="section-header">
                            <div></div>
                            <button id="addUserBtn" class="btn btn-primary">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 5px;">
                                    <path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Aggiungi Utente
                            </button>
                        </div>
                        <div id="usersList" class="users-list"></div>
                    </div>
                </div>

                <!-- Monthly Summary -->
                <div class="monthly-summary">
                    <div class="summary-card">
                        <div class="summary-label">Ore Totali</div>
                        <div class="summary-value" id="totalHours">0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Giorni Lavorativi</div>
                        <div class="summary-value" id="workDays">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Ferie</div>
                        <div class="summary-value" id="holidayDays">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">ROL</div>
                        <div class="summary-value" id="rolDays">0</div>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div id="calendarView" class="view-section active">
                    <div id="calendarGrid" class="calendar-grid"></div>
                </div>

                <!-- Table View -->
                <div id="tableView" class="view-section">
                    <div class="table-container">
                        <div class="table-wrapper">
                            <table id="employeeTable" class="employee-table">
                                <thead>
                                    <tr id="tableHeader">
                                        <th class="sticky-col day-col">#</th>
                                    </tr>
                                </thead>
                                <tbody id="employeeTableBody">
                                </tbody>
                                <tfoot>
                                    <tr id="tableTotals" class="totals-row">
                                        <td class="sticky-col"><strong class="vertical-text">TOT</strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Cambia Password</h3>
                <button class="modal-close" id="closePasswordModal">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <form id="changePasswordForm" class="time-form">
                <div class="form-group">
                    <label for="currentPassword">Password Attuale</label>
                    <input type="password" id="currentPassword" name="currentPassword" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">Nuova Password</label>
                    <input type="password" id="newPassword" name="newPassword" required minlength="4">
                    <small style="color: #666;">Minimo 4 caratteri</small>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Conferma Nuova Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelPasswordBtn">Annulla</button>
                    <button type="submit" class="btn btn-primary">Cambia Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Aggiungi Utente</h3>
                <button class="modal-close" id="closeUserModal">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <form id="userForm" class="time-form">
                <input type="hidden" id="editUserId" value="">
                <div class="form-group">
                    <label for="userName">Nome Completo</label>
                    <input type="text" id="userName" name="userName" required placeholder="Es: Mario Rossi">
                </div>
                <div class="form-group">
                    <label for="userUsername">Username (generato automaticamente)</label>
                    <input type="text" id="userUsername" name="userUsername">
                    <small style="color: #666;">Generato automaticamente da nome e cognome</small>
                </div>
                <div class="form-group">
                    <label for="userPassword">Password Iniziale</label>
                    <input type="password" id="userPassword" name="userPassword" required minlength="4">
                </div>
                <div class="form-group">
                    <label for="userRole">Ruolo</label>
                    <select id="userRole" name="userRole" required>
                        <option value="employee">Dipendente</option>
                        <option value="admin">Amministratore</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userFerie">Ferie Residue (in ore)</label>
                    <input type="number" id="userFerie" name="userFerie" value="208" min="0" step="0.01" required>
                    <small style="color: #666;">8 ore = 1 giorno</small>
                </div>
                <div class="form-group">
                    <label for="userRol">ROL Residui (in ore)</label>
                    <input type="number" id="userRol" name="userRol" value="120" min="0" step="0.01" required>
                    <small style="color: #666;">Include ex festivit√†</small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelUserBtn">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for First Time Password Setup -->
    <div id="firstTimeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Benvenuto! Imposta la tua Password</h3>
            </div>
            <form id="firstTimeForm" class="time-form">
                <div class="info-box" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                    <p style="margin: 0; font-size: 14px; color: #1976D2; line-height: 1.6;">
                        <strong>üìù Primo accesso:</strong><br>
                        Crea una password personale che userai per accedere all'app.<br>
                        La password deve contenere almeno 4 caratteri.
                    </p>
                </div>
                <div class="form-group">
                    <label for="firstTimeNewPassword">Nuova Password</label>
                    <input type="password" id="firstTimeNewPassword" name="firstTimeNewPassword" required minlength="4" placeholder="Minimo 4 caratteri">
                </div>
                <div class="form-group">
                    <label for="firstTimeConfirmPassword">Conferma Password</label>
                    <input type="password" id="firstTimeConfirmPassword" name="firstTimeConfirmPassword" required minlength="4" placeholder="Ripeti la password">
                </div>
                <div id="passwordError" class="error-message"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Imposta Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Time Entry -->
    <div id="timeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Inserisci Ore</h3>
                <button class="modal-close" id="closeModal">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
            <form id="timeForm" class="time-form">
                <input type="hidden" id="selectedDate">
                
                <div class="form-group">
                    <label>Tipo Giornata</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="dayType" value="work" checked>
                            <span>Lavoro</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="dayType" value="off">
                            <span>OFF</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="dayType" value="ferie">
                            <span>Ferie</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="dayType" value="rol">
                            <span>ROL</span>
                        </label>
                    </div>
                </div>

                <div id="timeInputs" class="time-inputs">
                    <div class="form-group">
                        <label for="startTime">Inizio Turno</label>
                        <input type="time" id="startTime" name="startTime">
                    </div>
                    <div class="form-group">
                        <label for="endTime">Fine Turno</label>
                        <input type="time" id="endTime" name="endTime">
                    </div>
                    <div class="hours-display" id="hoursDisplay">
                        <span class="hours-label">Ore Totali:</span>
                        <span class="hours-value" id="calculatedHours">0.00</span>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Holidays Modal -->
    <div id="holidaysModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">üéâ Festivit√† Italiane</h3>
                <button id="closeHolidaysModal" class="btn btn-secondary" style="display: flex; align-items: center; gap: 5px;">
                    <span>&times;</span>
                    <span>Chiudi</span>
                </button>
            </div>
            <div style="margin-bottom: 15px;">
                <label for="holidayYearSelect" style="margin-right: 10px; font-weight: 500;">Anno:</label>
                <select id="holidayYearSelect" class="form-control" style="display: inline-block; width: auto; padding: 8px;">
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                </select>
            </div>
            <div id="holidaysList" style="max-height: 500px; overflow-y: auto;">
                <!-- Lista festivit√† generata dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer id="appFooter" style="display: none; text-align: center; padding: 2rem 1rem; color: rgba(255, 255, 255, 0.9); font-size: 0.875rem; margin-top: 2rem; background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; flex-wrap: wrap;">
            <span style="font-size: 1rem;">‚ö°</span>
            <span>Powered by</span>
            <strong style="background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 1rem; font-weight: 700; letter-spacing: 0.5px;">Alessandro Costantini</strong>
            <span style="color: rgba(255, 255, 255, 0.5);">|</span>
            <span style="font-weight: 500;">¬© 2025</span>
        </div>
    </footer>

    <!-- ExcelJS library for Excel export with styles -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="firebase-config.js"></script>
    <script src="app.js"></script>
</body>
</html>
